databaseChangeLog:
  - changeSet:
      id: 001
      author: arsh
      runOnChange: false
      preConditions:
        - dbms:
            type: mysql
        - not:
            and:
              - tableExists:
                  tableName: products
              - tableExists:
                  tableName: users
              - tableExists:
                  tableName: product_features
      changes:
      # /** Create Users Table **/
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: username
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: email
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: password
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: false

              - column:
                  name: verification_code
                  type: VARCHAR(255)

              - column:
                  name: verification_expiration
                  type: DATETIME

              - column:
                  name: created_at
                  type: DATETIME
                  constraints:
                    nullable: false

              - column:
                  name: updated_at
                  type: DATETIME
                  constraints:
                    nullable: false

        # /** Create Products Table **/
        - createTable:
            tableName: products
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: tenant_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false

              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

              - column:
                  name: sku
                  type: VARCHAR(50)
                  constraints:
                    nullable: false

              - column:
                  name: category
                  type: VARCHAR(60)
                  constraints:
                    nullable: false

              - column:
                  name: price
                  type: DECIMAL(12,2)
                  constraints:
                    nullable: false

              - column:
                  name: description
                  type: VARCHAR(2000)

              - column:
                  name: created_at
                  type: DATETIME
                  constraints:
                    nullable: false

              - column:
                  name: updated_at
                  type: DATETIME
                  constraints:
                    nullable: false

        # /** Add Unique Constraint on tenant_id and sku **/
        - addUniqueConstraint:
            tableName: products
            columnNames: tenant_id, sku
            constraintName: uq_products_tenant_sku

        # /** Create Indexes **/
        - createIndex:
            tableName: products
            indexName: ix_products_tenant_sku
            unique: true
            columns:
              - column:
                  name: tenant_id
              - column:
                  name: sku

        - createIndex:
            tableName: products
            indexName: ix_products_tenant_category
            columns:
              - column:
                  name: tenant_id
              - column:
                  name: category

        - createIndex:
            tableName: products
            indexName: ix_products_tenant_name
            columns:
              - column:
                  name: tenant_id
              - column:
                  name: name

        # /** Create Product Features Table **/
        - createTable:
            tableName: product_features
            columns:
              - column:
                  name: product_id
                  type: BIGINT
                  constraints:
                    nullable: false

              - column:
                  name: feature_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

              - column:
                  name: features
                  type: VARCHAR(255)

        # /** Add Primary Key Constraints **/
        - addPrimaryKey:
            tableName: product_features
            columnNames: product_id, feature_key
            constraintName: pk_product_features

        # /** Add Foreign Key Constraints **/
        - addForeignKeyConstraint:
            baseTableName: product_features
            baseColumnNames: product_id
            referencedTableName: products
            referencedColumnNames: id
            constraintName: fk_product_features_product
            onDelete: CASCADE
